name: Test Evaluation Timing

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  test-evaluation-timing:
    name: Test post-run context evaluation timing
    runs-on: ubuntu-latest
    env:
      TEST_VAR: initial_value

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v6
        with:
          persist-credentials: false

      # This step sets up post-run-action with an expression referencing TEST_VAR
      # The expression ${{ env.TEST_VAR }} is evaluated at post-run time
      # so it will capture "modified_value", not the initial value
      - name: Setup post-run with expression
        id: post-run-test
        uses: ./
        with:
          post-run: |
            echo "Expression is evaluated at post-run time, not at step setup time"
            echo "Value from expression: ${{ env.TEST_VAR }}"
            echo "Current env value: $TEST_VAR"
            if [ "${{ env.TEST_VAR }}" = "modified_value" ]; then
              echo "✓ Confirmed: Expression was evaluated at post-run time"
            else
              echo "✗ Unexpected: Expression evaluation timing may have changed"
              exit 1
            fi
            if [ "$TEST_VAR" = "modified_value" ]; then
              echo "✓ Confirmed: Environment variable reflects the modified value at post-run time"
            else
              echo "Note: Environment variable value at post-run time: $TEST_VAR"
            fi

      # Modify the environment variable after the post-run-action step was set up
      - name: Modify environment variable
        run: |
          echo "TEST_VAR=modified_value" >> "$GITHUB_ENV"
          echo "Modified TEST_VAR to 'modified_value'"

      - name: Verify modification took effect
        run: |
          echo "Current TEST_VAR: $TEST_VAR"
          if [ "$TEST_VAR" = "modified_value" ]; then
            echo "✓ Environment variable was successfully modified"
          else
            echo "✗ Environment variable modification did not take effect"
            exit 1
          fi

  test-job-status-success:
    name: Test job.status evaluation (success case)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v6
        with:
          persist-credentials: false

      # Setup post-run-action with job.status expression
      # This will test what value job.status has during post-run
      - name: Setup post-run with job.status
        id: post-run-job-status
        uses: ./
        with:
          post-run: |
            echo "Testing job.status evaluation timing"
            echo "job.status from expression: ${{ job.status }}"
            echo "Expected: success (if evaluated at post-run time after all steps complete successfully)"

      - name: This step succeeds
        run: echo "This step completes successfully"

  # test-job-status-failure:
  #   name: Test job.status evaluation (failure case)
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout
  #       id: checkout
  #       uses: actions/checkout@v6
  #       with:
  #         persist-credentials: false

  #     # Setup post-run-action with job.status expression
  #     - name: Setup post-run with job.status
  #       id: post-run-job-status-failure
  #       uses: ./
  #       with:
  #         post-run: |
  #           echo "Testing job.status evaluation timing (failure case)"
  #           echo "job.status from expression: ${{ job.status }}"
  #           echo "Expected: failure (if evaluated at post-run time after a step fails)"

  #     - name: This step fails intentionally
  #       run: exit 1

  #     - name: This step is skipped
  #       if: success()
  #       run: echo "This should be skipped"
